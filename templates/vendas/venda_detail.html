{% extends "base.html" %}

{% block content %}

<h2>Venda #{{ venda.id }}</h2>

<div class="mb-3">
    <strong>Cliente:</strong> {{ venda.cliente }}<br>
    <strong>Data:</strong> {{ venda.data|date:"d/m/Y" }}<br>
    <strong>Status:</strong>
    {% if venda.status == 'aberta' %}
    <span class="badge bg-success">Aberta</span>
    {% elif venda.status == 'faturada' %}
    <span class="badge bg-primary">Faturada</span>
    {% else %}
    <span class="badge bg-secondary">Cancelada</span>
    {% endif %}
</div>

<hr>

<h5>Valores</h5>
<p>
    <strong>Valor total:</strong>
    R$ {{ venda.valor_total|floatformat:2 }}
</p>

<hr>

<h5>Pagamento (proposta copiada do or√ßamento)</h5>
<p>
    <strong>Tipo:</strong> {{ venda.get_tipo_pagamento_display|default:"‚Äî" }}<br>
    <strong>Condi√ß√µes:</strong> {{ venda.condicoes_pagamento|default:"‚Äî" }}<br>
    <strong>Observa√ß√µes:</strong> {{ venda.observacoes_pagamento|default:"‚Äî" }}
</p>

<hr>

<h5>Pagamento real</h5>

<form method="post" id="form-pagamento-venda">
    {% csrf_token %}
    <input type="hidden" name="acao" value="salvar_pagamento_real">

    <!-- LINHA PRINCIPAL -->
    <div class="row">
        <div class="col-md-3">
            <label>Tipo de pagamento</label>
            <select name="tipo_pagamento_real" id="tipo-pagamento-real" class="form-select">
                <option value="">Selecione</option>
                <option value="avista" {% if venda.tipo_pagamento_real == 'avista' %}selected{% endif %}>
                    √Ä vista
                </option>
                <option value="parcelado" {% if venda.tipo_pagamento_real == 'parcelado' %}selected{% endif %}>
                    Parcelado
                </option>
            </select>
        </div>

        <div class="col-md-3">
            <label>Forma de pagamento</label>
            <select name="forma_pagamento" id="forma-pagamento" class="form-select">
                <option value="">Selecione</option>
                <option value="dinheiro" {% if venda.forma_pagamento == 'dinheiro' %}selected{% endif %}>Dinheiro</option>
                <option value="pix" {% if venda.forma_pagamento == 'pix' %}selected{% endif %}>PIX</option>
                <option value="cartao_credito" {% if venda.forma_pagamento == 'cartao_credito' %}selected{% endif %}>
                    Cart√£o cr√©dito</option>
                <option value="cartao_debito" {% if venda.forma_pagamento == 'cartao_debito' %}selected{% endif %}>Cart√£o
                    d√©bito</option>
                <option value="boleto" {% if venda.forma_pagamento == 'boleto' %}selected{% endif %}>Boleto</option>
                <option value="transferencia" {% if venda.forma_pagamento == 'transferencia' %}selected{% endif %}>
                    Transfer√™ncia</option>
            </select>
        </div>

        <div class="col-md-3">
            <label>Data do pagamento</label>
            <input type="date" name="data_pagamento" id="data-pagamento" class="form-control"
                value="{{ venda.data_pagamento|date:'Y-m-d'|default:'' }}">
        </div>

        <div class="col-md-3">
            <label>Valor</label>
            <input type="text" step="0.01" name="valor_pagamento" id="valor-pagamento" class="form-control"
                value="{{ valor_pagamento }}">
        </div>
    </div>

    <!-- BLOCO PARCELAMENTO -->
    <div id="bloco-parcelamento" class="mt-4" style="display:none">
        <hr>
        <h6>Parcelamento</h6>

        <div class="row align-items-end">
            <div class="col-md-2">
                <label>Qtd. parcelas</label>
                <input type="number" id="qtd-parcelas" class="form-control" min="2"
                    value="{{ qtd_parcelas|default:2 }}">
            </div>

            <div class="col-md-2">
                <label>Intervalo (dias)</label>
                <input type="number" id="intervalo-dias" class="form-control" min="1" value="30">
            </div>

            <div class="col-md-3">
                <label>Data 1¬™ parcela</label>
                <input type="date" id="data-primeira" class="form-control">
            </div>

            <div class="col-md-3">
                <label>Valor 1¬™ parcela (entrada)</label>
                <input type="number" step="0.01" id="valor-entrada" class="form-control">
            </div>

            <div class="col-md-2">
                <button type="button" id="btn-gerar-parcelas" class="btn btn-outline-primary w-100">
                    ‚öôÔ∏è Gerar parcelas
                </button>
            </div>
        </div>
    </div>

    <!-- PARCELAS GERADAS -->
    <div id="bloco-parcelas-geradas" class="mt-4" style="display:none;">
        <h6>Parcelas geradas</h6>

        <table class="table table-bordered table-sm align-middle">
            <thead class="table-light">
                <tr>
                    <th>#</th>
                    <th>Vencimento</th>
                    <th>Valor</th>
                    <th>Forma de pagamento</th>
                    <th>Observa√ß√£o</th>
                    <th></th>
                </tr>
            </thead>
            <tbody id="parcelas-body">
                <!-- linhas geradas via JS -->
            </tbody>
        </table>
    </div>

    <!-- JSON DAS PARCELAS (ENVIADO PARA O BACKEND) -->
    <input type="hidden" name="parcelas_json" id="parcelas-json">
    <input type="hidden" name="alterou_parcelas" id="alterou-parcelas" value="0">


    <!-- OBSERVA√á√ïES GERAIS -->
    <div class="mt-3">
        <label>Observa√ß√µes gerais do pagamento</label>
        <textarea name="observacoes_pagamento" class="form-control"
            rows="2">{{ venda.observacoes_pagamento_real|default_if_none:'' }}</textarea>
    </div>

    <!-- BOT√ïES -->
    <div class="mt-4 d-flex justify-content-end gap-5">
        <a href="{% url 'clientes:venda_list' %}" class="btn btn-outline-secondary">
            Voltar
        </a>

        <button type="submit" class="btn btn-success">
            üíæ Salvar pagamento
        </button>  
    </div>
</form>

<!-- üî• DADOS DO BACKEND (parcelas j√° salvas) -->
{% if pagamento_existe %}
<script id="parcelas-backend" type="application/json">
[
{% for p in parcelas %}
{
  "numero": {{ p.numero }},
  "data": "{{ p.data_vencimento|date:'Y-m-d' }}",
  "valor": "{{ p.valor }}",
  "forma_pagamento": "{{ p.forma_pagamento|default:'' }}",
  "observacao": "{{ p.observacao|default:'' }}",
  "status": "{{ p.status }}"
}{% if not forloop.last %},{% endif %}
{% endfor %}
]
</script>
{% endif %}

<script>
    document.addEventListener('DOMContentLoaded', function () {

        const parcelasScript = document.getElementById('parcelas-backend');
        const temParcelasSalvas = !!parcelasScript;
        const valorPagamentoInput = document.getElementById('valor-pagamento');

        console.log('üîç temParcelasSalvas:', temParcelasSalvas);

        const tipo = document.getElementById('tipo-pagamento-real');
        const blocoParcelamento = document.getElementById('bloco-parcelamento');
        const blocoParcelas = document.getElementById('bloco-parcelas-geradas');
        const btnGerar = document.getElementById('btn-gerar-parcelas');
        const parcelasBody = document.getElementById('parcelas-body');
        const parcelasJson = document.getElementById('parcelas-json');
        const form = document.getElementById('form-pagamento-venda');

        // ==========================
        // üîí CONTROLE DE ALTERA√á√ÉO DO VALOR
        // ==========================

        if (valorPagamentoInput) {
            valorPagamentoInput.addEventListener('change', function () {

                if (temParcelasSalvas) {
                    alert(
                        'Voc√™ alterou o valor da venda. As parcelas precisam ser recalculadas.'
                    );

                    // Marca que parcelas precisam ser refeitas
                    document.getElementById('alterou-parcelas').value = '1';

                    // Limpa visualmente as parcelas antigas
                    const parcelasBody = document.getElementById('parcelas-body');
                    const blocoParcelas = document.getElementById('bloco-parcelas-geradas');

                    if (parcelasBody) parcelasBody.innerHTML = '';
                    if (blocoParcelas) blocoParcelas.style.display = 'none';
                }

            });
        }


        /* ==========================
           üî• CARREGAR PARCELAS SALVAS
        ========================== */
        if (temParcelasSalvas) {
            const parcelasSalvas = JSON.parse(parcelasScript.textContent);
            console.log('üì¶ Parcelas do backend:', parcelasSalvas);

            blocoParcelas.style.display = 'block';

            parcelasSalvas.forEach((p, index) => {
                parcelasBody.insertAdjacentHTML('beforeend', `
                    <tr>
                        <td>${p.numero}</td>
                        <td><input type="date" class="form-control form-control-sm parcela-data"
                                   value="${p.data}"></td>
                        <td><input type="text" step="0.01"
                                   class="form-control form-control-sm parcela-valor"
                                   value="${p.valor}"></td>
                        <td>
                            <select class="form-select form-select-sm parcela-forma">
                                <option value="">‚Äî</option>
                                <option value="pix" ${p.forma_pagamento === 'pix' ? 'selected' : ''}>PIX</option>
                                <option value="boleto" ${p.forma_pagamento === 'boleto' ? 'selected' : ''}>Boleto</option>
                                <option value="dinheiro" ${p.forma_pagamento === 'dinheiro' ? 'selected' : ''}>Dinheiro</option>
                                <option value="cartao_credito" ${p.forma_pagamento === 'cartao_credito' ? 'selected' : ''}>Cart√£o cr√©dito</option>
                                <option value="cartao_debito" ${p.forma_pagamento === 'cartao_debito' ? 'selected' : ''}>Cart√£o d√©bito</option>
                                <option value="transferencia" ${p.forma_pagamento === 'transferencia' ? 'selected' : ''}>Transfer√™ncia</option>
                            </select>
                        </td>
                        <td><input type="text" class="form-control form-control-sm parcela-obs"
                                   value="${p.observacao || ''}"></td>
                        <td class="text-center">
                            <button type="button" class="btn btn-sm btn-outline-danger"
                                    onclick="this.closest('tr').remove()">‚úñ</button>
                        </td>
                    </tr>
                `);
            });
            parcelasJson.value = JSON.stringify(parcelasSalvas);
        }

        /* ==========================
           VISIBILIDADE
        ========================== */
        function toggleParcelamento() {
            if (tipo.value === 'parcelado') {
                blocoParcelamento.style.display = 'block';

                // üî• Se j√° tem parcelas salvas, mostrar a tabela
                if (temParcelasSalvas) {
                    blocoParcelas.style.display = 'block';
                }
            } else {
                blocoParcelamento.style.display = 'none';

                // üî• S√≥ limpa se n√£o tem parcelas salvas
                if (!temParcelasSalvas) {
                    blocoParcelas.style.display = 'none';
                    parcelasBody.innerHTML = '';
                    parcelasJson.value = '';
                }
            }
        }

        tipo.addEventListener('change', toggleParcelamento);
        toggleParcelamento(); // üî• Chama ao carregar a p√°gina

        /* ==========================
        GERAR PARCELAS (JS)
        ========================== */
        btnGerar.addEventListener('click', function (e) {
            e.preventDefault();

            document.getElementById('alterou-parcelas').value = '1';

            if (temParcelasSalvas) {
                alert('Esta venda j√° possui parcelas. Para alterar, remova as parcelas existentes.');
                return;
            }

            const total = parseFloat(document.getElementById('valor-pagamento').value);
            const entradaRaw = document.getElementById('valor-entrada').value;
            const entrada = entradaRaw ? parseFloat(entradaRaw) : null;

            const qtd = parseInt(document.getElementById('qtd-parcelas').value);
            const intervalo = parseInt(document.getElementById('intervalo-dias').value) || 30;
            let dataBaseStr = document.getElementById('data-primeira').value;

            if (!total || !qtd || qtd < 1) {
                alert('Informe valor total e quantidade de parcelas.');
                return;
            }

            if (!dataBaseStr) {
                const hoje = new Date();
                dataBaseStr = hoje.toISOString().slice(0, 10);
                document.getElementById('data-primeira').value = dataBaseStr;
            }

            parcelasBody.innerHTML = '';
            blocoParcelas.style.display = 'block';

            const dataBase = new Date(dataBaseStr);

            let valorPrimeira, valorDemais;

            if (!entrada) {
                valorPrimeira = (total / qtd).toFixed(2);
                valorDemais = valorPrimeira;
            } else {
                valorPrimeira = entrada.toFixed(2);
                const restante = total - entrada;
                valorDemais = (restante / (qtd - 1)).toFixed(2);
            }

            for (let i = 0; i < qtd; i++) {
                const data = new Date(dataBase);
                data.setDate(data.getDate() + (i * intervalo));

                const valor = (i === 0) ? valorPrimeira : valorDemais;

                parcelasBody.insertAdjacentHTML('beforeend', `
            <tr>
                <td>${i + 1}</td>
                <td>
                    <input type="date" class="form-control form-control-sm parcela-data"
                           value="${data.toISOString().slice(0, 10)}">
                </td>
                <td>
                    <input type="text"                           class="form-control form-control-sm parcela-valor"
                           value="${valor}">
                </td>
                <td>
                    <select class="form-select form-select-sm parcela-forma">
                        <option value="">‚Äî</option>
                        <option value="pix">PIX</option>
                        <option value="boleto">Boleto</option>
                        <option value="dinheiro">Dinheiro</option>
                        <option value="cartao_credito">Cart√£o cr√©dito</option>
                        <option value="cartao_debito">Cart√£o d√©bito</option>
                        <option value="transferencia">Transfer√™ncia</option>
                    </select>
                </td>
                <td>
                    <input type="text" class="form-control form-control-sm parcela-obs">
                </td>
                <td class="text-center">
                    <button type="button" class="btn btn-sm btn-outline-danger"
                            onclick="this.closest('tr').remove()">‚úñ</button>
                </td>
            </tr>
        `);
            }
        });

        /* ==========================
        SUBMIT ‚Üí NORMALIZA E MONTA parcelas_json
        ========================== */
        form.addEventListener('submit', function (e) {

            const linhas = parcelasBody.querySelectorAll('tr');
            const parcelas = [];

            linhas.forEach((linha, index) => {

                let valorRaw = linha.querySelector('.parcela-valor').value;

                // üî• NORMALIZA N√öMERO (remove milhar e troca v√≠rgula por ponto)
                valorRaw = String(valorRaw)
                    .replace(/\./g, '')
                    .replace(',', '.');

                linha.querySelector('.parcela-valor').value = valorRaw;

                parcelas.push({
                    numero: index + 1,
                    data: linha.querySelector('.parcela-data').value,
                    valor: valorRaw,
                    forma_pagamento: linha.querySelector('.parcela-forma').value,
                    observacao: linha.querySelector('.parcela-obs').value
                });
            });

            parcelasJson.value = JSON.stringify(parcelas);

            console.log('üì¶ parcelas_json normalizado:', parcelasJson.value);
        });


    });
</script>

{% endblock %}