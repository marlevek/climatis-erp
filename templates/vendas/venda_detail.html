{% extends "base.html" %}

{% block content %}

<h2>Venda #{{ venda.id }}</h2>

<div class="mb-3">
    <strong>Cliente:</strong> {{ venda.cliente }}<br>
    <strong>Data:</strong> {{ venda.data|date:"d/m/Y" }}<br>
    <strong>Status:</strong>
    {% if venda.status == 'aberta' %}
    <span class="badge bg-success">Aberta</span>
    {% elif venda.status == 'faturada' %}
    <span class="badge bg-primary">Faturada</span>
    {% else %}
    <span class="badge bg-secondary">Cancelada</span>
    {% endif %}
</div>

<hr>

<h5>Valores</h5>
<p>
    <strong>Valor total:</strong>
    R$ {{ venda.valor_total|floatformat:2 }}
</p>

<hr>

<h5>Pagamento (proposta copiada do or√ßamento)</h5>
<p>
    <strong>Tipo:</strong> {{ venda.get_tipo_pagamento_display|default:"‚Äî" }}<br>
    <strong>Condi√ß√µes:</strong> {{ venda.condicoes_pagamento|default:"‚Äî" }}<br>
    <strong>Observa√ß√µes:</strong> {{ venda.observacoes_pagamento|default:"‚Äî" }}
</p>

<hr>

<h5>Pagamento real</h5>

<form method="post">
    {% csrf_token %}
    <input type="hidden" name="acao" value="salvar_pagamento_real">
    <input type="hidden" name="parcelas_json" id="parcelas-json">

    <!-- LINHA PRINCIPAL -->
    <div class="row">
        <div class="col-md-3">
            <label>Tipo de pagamento</label>
            <select name="tipo_pagamento_real" id="tipo-pagamento-real" class="form-select">
                <option value="">Selecione</option>
                <option value="avista">√Ä vista</option>
                <option value="parcelado">Parcelado</option>
            </select>
        </div>

        <div class="col-md-3">
            <label>Forma de pagamento</label>
            <select name="forma_pagamento" id="forma-pagamento" class="form-select">
                <option value="">Selecione</option>
                <option value="dinheiro">Dinheiro</option>
                <option value="pix">PIX</option>
                <option value="cartao_credito">Cart√£o cr√©dito</option>
                <option value="cartao_debito">Cart√£o d√©bito</option>
                <option value="boleto">Boleto</option>
                <option value="transferencia">Transfer√™ncia</option>
            </select>
        </div>

        <div class="col-md-3">
            <label>Data do pagamento</label>
            <input type="date" name="data_pagamento" id="data-pagamento" class="form-control">
        </div>

        <div class="col-md-3">
            <label>Valor</label>
            <input type="number" step="0.01" name="valor_pagamento" id="valor-pagamento" class="form-control"
                value="{{ venda.valor_total }}">
        </div>
    </div>

    <!-- BLOCO PARCELAMENTO -->
    <div id="bloco-parcelamento" class="mt-4" style="display:none">
        <hr>
        <h6>Parcelamento</h6>

        <div class="row align-items-end">
            <div class="col-md-2">
                <label>Qtd. parcelas</label>
                <input type="number" id="qtd-parcelas" class="form-control" min="2" value="2">
            </div>

            <div class="col-md-2">
                <label>Intervalo (dias)</label>
                <input type="number" id="intervalo-dias" class="form-control" min="1" value="30">
            </div>

            <div class="col-md-3">
                <label>Data 1¬™ parcela</label>
                <input type="date" id="data-primeira" class="form-control">
            </div>

            <div class="col-md-3">
                <label>Valor 1¬™ parcela (entrada)</label>
                <input type="number" step="0.01" id="valor-entrada" class="form-control">
            </div>

            <div class="col-md-2">
                <button type="button" id="btn-gerar-parcelas" class="btn btn-outline-primary w-100">
                    ‚öôÔ∏è Gerar parcelas
                </button>
            </div>
        </div>
    </div>

 <!-- PARCELAS GERADAS -->
<div id="bloco-parcelas-geradas" class="mt-4" style="display:none;">
    <h6>Parcelas geradas</h6>

    <table class="table table-bordered table-sm align-middle">
        <thead class="table-light">
            <tr>
                <th>#</th>
                <th>Vencimento</th>
                <th>Valor</th>
                <th>Forma de pagamento</th>
                <th>Observa√ß√£o</th>
                <th></th>
            </tr>
        </thead>
        <tbody id="parcelas-body">
            <!-- linhas geradas via JS -->
        </tbody>
    </table>
</div>

<!-- JSON DAS PARCELAS (ENVIADO PARA O BACKEND) -->
<input type="hidden" name="parcelas_json" id="parcelas-json">

<!-- OBSERVA√á√ïES GERAIS -->
<div class="mt-3">
    <label>Observa√ß√µes gerais do pagamento</label>
    <textarea name="observacoes_pagamento"
              class="form-control"
              rows="2">{{ venda.observacoes_pagamento_real|default_if_none:'' }}</textarea>
</div>

<!-- BOT√ïES -->
<div class="mt-4 d-flex justify-content-between">
    <a href="{% url 'clientes:venda_list' %}" class="btn btn-outline-secondary">
        Voltar
    </a>

    <button type="submit" class="btn btn-success">
        üíæ Salvar pagamento
    </button>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {

    const tipo = document.getElementById('tipo-pagamento-real');
    const blocoParcelamento = document.getElementById('bloco-parcelamento');
    const blocoParcelas = document.getElementById('bloco-parcelas-geradas');
    const btnGerar = document.getElementById('btn-gerar-parcelas');
    const parcelasBody = document.getElementById('parcelas-body');
    const parcelasJson = document.getElementById('parcelas-json');
    const form = document.querySelector('form');

    function toggleParcelamento() {
        if (tipo.value === 'parcelado') {
            blocoParcelamento.style.display = 'block';
        } else {
            blocoParcelamento.style.display = 'none';
            blocoParcelas.style.display = 'none';
            parcelasBody.innerHTML = '';
            parcelasJson.value = '';
        }
    }

    tipo.addEventListener('change', toggleParcelamento);
    toggleParcelamento();

    // GERAR PARCELAS (SEM RELOAD)
    btnGerar.addEventListener('click', function (e) {
        e.preventDefault();

        const total = parseFloat(document.getElementById('valor-pagamento').value);
        const entrada = parseFloat(document.getElementById('valor-entrada').value) || 0;
        const qtd = parseInt(document.getElementById('qtd-parcelas').value);
        const intervalo = parseInt(document.getElementById('intervalo-dias').value);
        const dataBaseStr = document.getElementById('data-primeira').value;

        if (!total || !qtd || !dataBaseStr || qtd < 2) {
            alert('Preencha corretamente os dados de parcelamento.');
            return;
        }

        if (entrada < 0 || entrada > total) {
            alert('Valor da 1¬™ parcela inv√°lido.');
            return;
        }

        parcelasBody.innerHTML = '';
        blocoParcelas.style.display = 'block';

        const dataBase = new Date(dataBaseStr);
        const restante = total - entrada;
        const qtdRestante = qtd - 1;
        const valorRestante = (restante / qtdRestante).toFixed(2);

        for (let i = 0; i < qtd; i++) {
            const data = new Date(dataBase);
            data.setDate(data.getDate() + (i * intervalo));
            const dataStr = data.toISOString().slice(0, 10);

            const valor = (i === 0) ? entrada.toFixed(2) : valorRestante;

            parcelasBody.insertAdjacentHTML('beforeend', `
                <tr>
                    <td>${i + 1}</td>
                    <td>
                        <input type="date"
                               class="form-control form-control-sm parcela-data"
                               value="${dataStr}">
                    </td>
                    <td>
                        <input type="number"
                               step="0.01"
                               class="form-control form-control-sm parcela-valor"
                               value="${valor}">
                    </td>
                    <td>
                        <select class="form-select form-select-sm parcela-forma">
                            <option value="">‚Äî</option>
                            <option value="pix">PIX</option>
                            <option value="boleto">Boleto</option>
                            <option value="dinheiro">Dinheiro</option>
                            <option value="cartao_credito">Cart√£o cr√©dito</option>
                            <option value="cartao_debito">Cart√£o d√©bito</option>
                            <option value="transferencia">Transfer√™ncia</option>
                        </select>
                    </td>
                    <td>
                        <input type="text"
                               class="form-control form-control-sm parcela-obs"
                               placeholder="Obs. da parcela">
                    </td>
                    <td class="text-center">
                        <button type="button"
                                class="btn btn-sm btn-outline-danger"
                                onclick="this.closest('tr').remove()">‚úñ</button>
                    </td>
                </tr>
            `);
        }
    });

    // ANTES DE SALVAR ‚Üí MONTA O JSON DAS PARCELAS
    form.addEventListener('submit', function () {

        const linhas = parcelasBody.querySelectorAll('tr');
        const parcelas = [];

        linhas.forEach((linha, index) => {
            parcelas.push({
                numero: index + 1,
                data: linha.querySelector('.parcela-data').value,
                valor: linha.querySelector('.parcela-valor').value,
                forma_pagamento: linha.querySelector('.parcela-forma').value,
                observacao: linha.querySelector('.parcela-obs').value
            });
        });

        parcelasJson.value = JSON.stringify(parcelas);
    });

});
</script>

{% endblock %}